name: Deploy to AWS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted  # AWS에서 직접 실행
    
    steps:
      # 1. 깃허브에서 최신 코드를 현재 러너 폴더로 가져옴
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. .env 파일 생성
      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          

      # 3. 도커 배포 명령 실행 (SSH 접속 없이 바로 명령어 입력)
      - name: Deploy with Docker Compose
        run: |
          # 기존 컨테이너 내리고 정리 (용량 확보)
          docker-compose down
          docker system prune -a -f
          docker image prune -f
          
          # 캐시 없이 다시 빌드 (최신 코드 반영)
          docker-compose build --no-cache backend
          
          # 백그라운드 실행
          docker-compose up -d backend
          
          # 프리즈마 마이그레이션 (DB 업데이트)
          docker-compose exec -T backend npx prisma migrate deploy || echo "Migration skipped"